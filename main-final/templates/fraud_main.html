<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibraFinFact</title>
    <link rel="stylesheet" href="{{url_for('static',filename='style.css')}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href=https://cdn.jsdelivr.net/sweetalert2/5.3.8/sweetalert2.css>
    <link rel="icon" href="{{url_for('static',filename='favicon.ico')}}">
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="{{url_for('static',filename='favicon.ico')}}" alt="Logo">
            <span>LibraFinFact</span>
        </div>
        <button class="new-thread"><span>New Chat</span></button>
        <nav>
            <a href="/"><i class="icon">üè†</i> Home</a>
            <a href="/news_feed"><i class="icon">üì∞</i> News Feed</a>
            <a href="/fake_detection" class="active"><i class="icon">üîç</i> Discrepancy Detector</a>
        </nav>
        <div class="auth-buttons">
            <button class="sign-up">Sign Up</button>
            <button class="log-in">Log in</button>
        </div>
    </div>
    <div style="display:flex; flex-direction: column;" id="main-box">
    <div class="input-area">
            <button class="add">+</button>
            <input id="myInput" type="text" placeholder="Ask follow-up">
            <button class="mic-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                  <line x1="12" x2="12" y1="19" y2="22"/>
                </svg>
              </button>
        </div>
    
     
    </div>
    <div class="right-sidebar">
        <div id="pdf-viewer" class="pdf-container glass-card">
            <embed id="pdf-frame" src="">
          </div>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js'></script>
    <script src="https://cdn.jsdelivr.net/sweetalert2/5.3.8/sweetalert2.js"></script>

    <script>
        
        
        
        var info = {{info|tojson}}
        let info1="";
        let additionalCards1=[];
        const pdfFrame = document.getElementById('pdf-frame');
        console.log(info["url"]);
        
        pdfFrame.src = "data:application/pdf;base64,"+info["url"];
        var sd = {{sd|tojson}}
        // Show all functionality
        // const showAllBtn = document.getElementById('showAll');
        // const sourceCardsContainer = document.getElementById('sourceCards');
        let expanded = {};
        expanded[info["query_no"]]=false;
        
        
        function show() {
          
          parent = $(this).parent()[0];
          console.log(parent)
          sourceCardsContainer = parent.querySelector('#sourceCards');
          showAllBtn = parent.querySelector('#showAll');
          console.log(showAllBtn)
          query_number = parent.querySelector('#unique-no');
          
          // Tooltip functionality
          sourceCards = parent.querySelectorAll('.source-card');
          sourceCards.forEach(card => {
              card.addEventListener('mouseover', (e) => {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'tooltip';
                  tooltip.textContent = card.dataset.tooltip;
                  card.appendChild(tooltip);
              });
  
              card.addEventListener('mouseout', () => {
                  const tooltip = card.querySelector('.tooltip');
                  if (tooltip) {
                      tooltip.remove();
                  }
              });
          });
          
          if (!expanded[query_number]) {
                additionalCards.forEach(card => {
                    const newCard = document.createElement('div');
                    newCard.className = 'source-card';
                    newCard.style = card.color;
                    newCard.dataset.tooltip = card.tooltip;
                    newCard.innerHTML = `
                        <a href=${card.link} style="text-decoration:none; color:white;">
			<h3 style=${card.textcolor}>${card.title}</h3>
			<span class="source-url" style="display:flex; flex-direction:row; align-items:center; ${card.textcolor}"><img src=${card.favi} width="30" height="30" alt="Avatar" style="padding:5px; border:1px solid white; border-radius:50%;">&nbsp; ${card.url}</span>
                        </a>
                    `;
                    
                    // Add tooltip functionality to new cards
                    newCard.addEventListener('mouseover', (e) => {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';
                        tooltip.textContent = card.tooltip;
                        newCard.appendChild(tooltip);
                    });

                    newCard.addEventListener('mouseout', () => {
                        const tooltip = newCard.querySelector('.tooltip');
                        if (tooltip) {
                            tooltip.remove();
                        }
                    });

                    sourceCardsContainer.appendChild(newCard);
                });
                showAllBtn.textContent = 'Show less';
                expanded[query_number] = true;
            } else {
                const cards = sourceCardsContainer.querySelectorAll('.source-card');
                for (let i = 3; i < cards.length; i++) {
                    cards[i].remove();
                }
                showAllBtn.textContent = 'Show all';
                expanded[query_number] = false;
            }
          
          
        }
        
        function show1() {
          
          parent = $(this).parent()[0];
          console.log(parent)
          sourceCardsContainer = parent.querySelector('#sourceCards');
          showAllBtn = parent.querySelector('#showAll');
          console.log(showAllBtn)
          query_number = parent.querySelector('#unique-no');
          
          // Tooltip functionality
          sourceCards = parent.querySelectorAll('.source-card');
          sourceCards.forEach(card => {
              card.addEventListener('mouseover', (e) => {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'tooltip';
                  tooltip.textContent = card.dataset.tooltip;
                  card.appendChild(tooltip);
              });
  
              card.addEventListener('mouseout', () => {
                  const tooltip = card.querySelector('.tooltip');
                  if (tooltip) {
                      tooltip.remove();
                  }
              });
          });
          
          if (!expanded[query_number]) {
                additionalCards1.forEach(card => {
                    const newCard = document.createElement('div');
                    newCard.className = 'source-card';
                    newCard.style = card.color;
                    newCard.dataset.tooltip = card.tooltip;
                    newCard.innerHTML = `
                        <a href=${card.link} style="text-decoration:none; color:white;">
			<h3 style=${card.textcolor}>${card.title}</h3>
			<span class="source-url" style="display:flex; flex-direction:row; align-items:center; ${card.textcolor}"><img src=${card.favi} width="30" height="30" alt="Avatar" style="padding:5px; border:1px solid white; border-radius:50%;">&nbsp; ${card.url}</span>
                        </a>
                    `;
                    
                    // Add tooltip functionality to new cards
                    newCard.addEventListener('mouseover', (e) => {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';
                        tooltip.textContent = card.tooltip;
                        newCard.appendChild(tooltip);
                    });

                    newCard.addEventListener('mouseout', () => {
                        const tooltip = newCard.querySelector('.tooltip');
                        if (tooltip) {
                            tooltip.remove();
                        }
                    });

                    sourceCardsContainer.appendChild(newCard);
                });
                showAllBtn.textContent = 'Show less';
                expanded[query_number] = true;
            } else {
                const cards = sourceCardsContainer.querySelectorAll('.source-card');
                for (let i = 3; i < cards.length; i++) {
                    cards[i].remove();
                }
                showAllBtn.textContent = 'Show all';
                expanded[query_number] = false;
            }
          
          
        }
        
        
        
        
        
        console.log(sd);
        
        var additionalCards = [];
        var back_color = "";
        for (var i=3;i<sd["Title"].length;i++) {
        
         if (sd["cite_state"][i]=="official") {
          back_color = "background-color:#a855f7; border: 1px solid white;";
          text_color = "color:black;"
          }
          else {
          back_color = "background-color:black; border: 1px solid white;"
	  text_color="color:white;"
          }
        additionalCards.push({
                title: sd["Title"][i],
                url: sd["Sites"][i],
                tooltip: "Click to read more about "+sd["Title"][i],
                link: sd["Links"][i],
                favi:sd["Favicon"][i],
                color: back_color,
		textcolor:text_color
        })
        }
        console.log(additionalCards);
        
        
        
        
        main_box = document.getElementById("main-box")
        
        main_ele = document.createElement("main");
        
        // Header Block
       
        
        
        header_ele = document.createElement("header");
        
        
        div_ele1 = document.createElement("div");
        div_ele1.setAttribute("class", "header-left");
        
        span_ele1 = document.createElement("span");
        span_ele1.setAttribute("class", "time");
        span_ele1.innerHTML = "Now"
        div_ele1.appendChild(span_ele1);
        
        h1_ele1 = document.createElement("h1");
        h1_ele1.setAttribute("id", "query");
        h1_ele1.innerHTML = info["query"];
        div_ele1.appendChild(h1_ele1);
        
        header_ele.appendChild(div_ele1);
        
        div_ele2 = document.createElement("div");
        div_ele2.setAttribute("class", "header-right");
        
        button_ele1 = document.createElement("button");
        button_ele1.setAttribute("class", "bookmark");
        button_ele1.innerHTML="üìã";
        div_ele2.appendChild(button_ele1);

        button_ele2 = document.createElement("button");
        button_ele2.setAttribute("class", "link");
        button_ele2.innerHTML="üíæ";
        div_ele2.appendChild(button_ele2);

        button_ele3 = document.createElement("button");
        button_ele3.setAttribute("class", "share");
        button_ele3.innerHTML="Share";
        div_ele2.appendChild(button_ele3);
        
        header_ele.appendChild(div_ele2);
        
        main_ele.appendChild(header_ele);
        
        // Section Block
        
                
                
        section_ele = document.createElement("section");
        section_ele.setAttribute("class", "sources");
        
        input_ele2 = document.createElement("input");
        input_ele2.setAttribute("type", "hidden")
        input_ele2.setAttribute("id", "unique-no")
        input_ele2.setAttribute("value", info["query_no"])
        section_ele.appendChild(input_ele2);
        
        h2_ele1 = document.createElement("h2");
        h2_ele1.innerHTML = "Sources";
        section_ele.appendChild(h2_ele1);
        
        div_ele3 = document.createElement("div");
        div_ele3.setAttribute("class", "source-cards");
        div_ele3.setAttribute("id", "sourceCards");
       
        
        for (var i=1;i<4;i++) {
        
          
          div_ele4 = document.createElement("div");
          div_ele4.setAttribute("class", "source-card");
          div_ele4.setAttribute("id", "source-card"+i.toString());
          if (sd["cite_state"][i-1]=="official") {
          div_ele4.setAttribute("style", "background-color:#a855f7; border:1px solid white;");
          }
          else {
          div_ele4.setAttribute("style", "background-color:black; border:1px solid white;");
          }
          div_ele4.setAttribute("data-tooltip", "Click to read more about "+sd["Title"][i-1]);
          
          a_ele1 = document.createElement("a");
          a_ele1.setAttribute("href", sd["Links"][i-1]);
          a_ele1.setAttribute("style", "text-decoration:none; color:white;");
          a_ele1.setAttribute("id", "link"+i.toString());
          
          h3_ele1 = document.createElement("h3");
          h3_ele1.setAttribute("id", "title"+i.toString());
	  if (sd["cite_state"][i-1]=="official") {
          h3_ele1.setAttribute("style", "color:black;");
          }
          else {
          h3_ele1.setAttribute("style", "color:white;");
          }

          h3_ele1.innerHTML = sd["Title"][i-1];
          a_ele1.appendChild(h3_ele1);
          
          span_ele1 = document.createElement("span");
          span_ele1.setAttribute("id", "site1");
          span_ele1.setAttribute("class", "source-url");
	  if (sd["cite_state"][i-1]=="official") {
          span_ele1.setAttribute("style", "display:flex; flex-direction:row; align-items:center; color:black;");	 
	  }
	  else {
          span_ele1.setAttribute("style", "display:flex; flex-direction:row; align-items:center; color:white;")
	  }

          span_ele1.innerHTML = '<img src='+sd["Favicon"][i-1]+' alt="Avatar"  width="30" height="30" style="padding:5px; border:1px solid white; border-radius:50%; ">&nbsp;'+sd["Sites"][i-1];
          a_ele1.appendChild(span_ele1);
          
          div_ele4.appendChild(a_ele1);
          div_ele3.appendChild(div_ele4);
          
        }
        
        
        section_ele.appendChild(div_ele3);
        
        button_ele4 = document.createElement("button");
        button_ele4.setAttribute("class", "show-all");
        button_ele4.setAttribute("id", "showAll");
        button_ele4.innerHTML="Show all";
        button_ele4.addEventListener("click", show);
        section_ele.appendChild(button_ele4);
        
        main_ele.appendChild(section_ele);
        
        section_ele2 = document.createElement("section");
        section_ele2.setAttribute("class", "answer");
        section_ele2.setAttribute("id", "answer");
        section_ele2.innerHTML = info["para"]+"<br><br>";
        
        
        main_ele.appendChild(section_ele2);
        
        main_box.appendChild(main_ele);
        
        

var input = document.getElementById("myInput");
let mes = info["messages"];
let qn = info["query_no"];

// Execute a function when the user presses a key on the keyboard
input.addEventListener("keypress", function(event) {
  // If the user presses the "Enter" key on the keyboard
  if (event.key === "Enter") {
    // Cancel the default action, if needed
    console.log("dfd");
    event.preventDefault();
    // Trigger the button element with a click
    swal({
     text:"LibraFinFact is Acquiring Data and Performing Analysis for You",
    title: 'Please Wait...',
    allowEscapeKey: false,
    allowOutsideClick: false,
    onOpen: () => {
      swal.showLoading();
    }
  }).catch(
    () => {}
  );
    
    var form = new FormData();
        form.append("query", input.value);
        form.append("messages", mes);
        $.ajax({
            type: 'POST',
            url: '/follow_up_query',
            data: JSON.stringify({"query":input.value,"messages":mes,"query_no":qn}),
            dataType: "json",
            cache: false,
            processData: false,
            contentType: "application/json; charset=utf-8"

        }).done(function(data) {
            console.log(data);
            
            info1 = data;
        
            var sd1 = data;
            
            
            mes = info1["messages"]
            qn = info1["query_no"]
            
            expanded[info1["query_no"]] = false;
            console.log(expanded);
            console.log(sd);
            additionalCards1=[];
            
            for (var i=3;i<sd1["Title"].length;i++) {
            if (sd1["cite_state"][i]=="official") {
            back_color = "background-color:#a855f7; border: 1px solid white;";
	    text_color = "color:black;"
            }
            else {
            back_color = "background-color:black; border: 1px solid white;";
	    text_color = "color:black;"
            }
            additionalCards1.push({
                    title: sd1["Title"][i],
                    url: sd1["Sites"][i],
                    tooltip: "Click to read more about "+sd1["Title"][i],
                    link: sd1["Links"][i],
                    favi:sd1["Favicon"][i],
                    color: back_color,
		    textcolor: text_color
            })
            }
            console.log(additionalCards1);
            
            main_box = document.getElementById("main-box")
        
        main_ele = document.createElement("main");
        
        // Header Block
        
        header_ele = document.createElement("header");
        
        div_ele1 = document.createElement("div");
        div_ele1.setAttribute("class", "header-left");
        
        span_ele1 = document.createElement("span");
        span_ele1.setAttribute("class", "time");
        span_ele1.innerHTML = "Now"
        div_ele1.appendChild(span_ele1);
        
        h1_ele1 = document.createElement("h1");
        h1_ele1.setAttribute("id", "query");
        h1_ele1.innerHTML = info1["query"];
        div_ele1.appendChild(h1_ele1);
        
        header_ele.appendChild(div_ele1);
        
        div_ele2 = document.createElement("div");
        div_ele2.setAttribute("class", "header-right");
        
        button_ele1 = document.createElement("button");
        button_ele1.setAttribute("class", "bookmark");
        button_ele1.innerHTML="üìã";
        div_ele2.appendChild(button_ele1);

        button_ele2 = document.createElement("button");
        button_ele2.setAttribute("class", "link");
        button_ele2.innerHTML="üíæ";
        div_ele2.appendChild(button_ele2);

        button_ele3 = document.createElement("button");
        button_ele3.setAttribute("class", "share");
        button_ele3.innerHTML="Share";
        div_ele2.appendChild(button_ele3);
        
        header_ele.appendChild(div_ele2);
        
        main_ele.appendChild(header_ele);
        
        // Section Block
        
                
                
        section_ele = document.createElement("section");
        section_ele.setAttribute("class", "sources");
        
        input_ele2 = document.createElement("input");
        input_ele2.setAttribute("type", "hidden")
        input_ele2.setAttribute("id", "unique-no")
        input_ele2.setAttribute("value", info1["query_no"])
        section_ele.appendChild(input_ele2);
        
        h2_ele1 = document.createElement("h2");
        h2_ele1.innerHTML = "Sources";
        section_ele.appendChild(h2_ele1);
        
        div_ele3 = document.createElement("div");
        div_ele3.setAttribute("class", "source-cards");
        div_ele3.setAttribute("id", "sourceCards");
       
        
        for (var i=1;i<4;i++) {
          div_ele4 = document.createElement("div");
          div_ele4.setAttribute("class", "source-card");
          div_ele4.setAttribute("id", "source-card"+i.toString());
          div_ele4.setAttribute("data-tooltip", "Click to read more about "+sd1["Title"][i-1]);
          if (sd1["cite_state"][i-1]=="official") {
          div_ele4.setAttribute("style", "background-color:#a855f7; border:1px solid white;");
          }
          else {
          div_ele4.setAttribute("style", "background-color:black; border:1px solid white;");
          }
          
          a_ele1 = document.createElement("a");
          a_ele1.setAttribute("href", sd1["Links"][i-1]);
          a_ele1.setAttribute("style", "text-decoration:none; color:white;");
          a_ele1.setAttribute("id", "link"+i.toString());
          
          h3_ele1 = document.createElement("h3");
          h3_ele1.setAttribute("id", "title"+i.toString());
          h3_ele1.innerHTML = sd1["Title"][i-1];
          a_ele1.appendChild(h3_ele1);
          
          span_ele1 = document.createElement("span");
          span_ele1.setAttribute("id", "site1");
          span_ele1.setAttribute("class", "source-url");
          if (sd["cite_state"][i-1]=="official") {
          span_ele1.setAttribute("style", "display:flex; flex-direction:row; align-items:center; color:black;");
          }
          else {
          span_ele1.setAttribute("style", "display:flex; flex-direction:row; align-items:center; color:white;")
          }

          span_ele1.innerHTML = '<img src='+sd1["Favicon"][i-1]+' alt="Avatar"  width="30" height="30" style="padding:5px; border:1px solid white; border-radius:50%;">&nbsp;'+sd1["Sites"][i-1];
          a_ele1.appendChild(span_ele1);
          
          div_ele4.appendChild(a_ele1);
          div_ele3.appendChild(div_ele4);
          
        }
        
        
        section_ele.appendChild(div_ele3);
        
        button_ele4 = document.createElement("button");
        button_ele4.setAttribute("class", "show-all");
        button_ele4.setAttribute("id", "showAll");
        button_ele4.innerHTML="Show all";
        button_ele4.addEventListener("click", show1);
        section_ele.appendChild(button_ele4);
        
        main_ele.appendChild(section_ele);
        
        section_ele2 = document.createElement("section");
        section_ele2.setAttribute("class", "answer");
        section_ele2.setAttribute("id", "answer");
        section_ele2.innerHTML = info1["para"]+"<br><br>";
        
        
        main_ele.appendChild(section_ele2);
        
        main_box.appendChild(main_ele);
            
        input.value = "";
            swal.close();
            
      })
      
  }
});

const micBtn = document.querySelector('.mic-btn');

// Handle microphone
   // Audio Recording
  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;

  // Request microphone access
  async function setupMicrophone() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        console.log('Recording stopped, audio URL:', audioUrl);
        
        var form = new FormData();

            form.append("audio_data", audioBlob);
             $.ajax({
                  type: 'POST',
                  url: '/audio_save',
                  data: form,
                  cache: false,
                  processData: false,
                  contentType: false
      
              }).done(function(data) {
              console.log(data);
              input.value = data["transcript"]
              
        
      });
        // Reset chunks for next recording
        audioChunks = [];
      };

      return true;
    } catch (error) {
      console.error('Error accessing microphone:', error);
      return false;
    }
  }

  // Handle microphone button
  micBtn.addEventListener('click', async () => {
    if (!mediaRecorder) {
      const initialized = await setupMicrophone();
      if (!initialized) {
        alert('Could not access microphone');
        return;
      }
    }

    isRecording = !isRecording;
    micBtn.style.color = isRecording ? '#ef4444' : '#9ca3af';

    if (isRecording) {
      audioChunks = [];
      mediaRecorder.start();
      console.log('Recording started');
    } else {
      mediaRecorder.stop();
      console.log('Recording stopped');
    }
  });   
        
        
    </script>
</body>
</html>
